# MedTrack API Requirements (Generated by GPT)

## Overview
This document lists every API endpoint required by the MedTrack frontend, based on a deep analysis of all UI and service code. It is designed for a Node.js/Express backend using Supabase for authentication, Wasabi for file storage, Postgres for the database, and Firebase for notifications. Each endpoint includes method, path, parameters, request/response structure, and notes on integration, validation, and edge cases. This is intended to be production-ready and exhaustive.

---

## 1. Authentication & User Management

### POST `/api/auth/register`
**Purpose:** Register a new user (Supabase)

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "StrongPassword123!",
  "name": "John Doe"
}
```
**Validation:**
- `email`: required, valid email format, unique
- `password`: required, min 8 chars, strong (uppercase, lowercase, number, symbol)
- `name`: required, min 2 chars

**Response:**
```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "caregiver"
  },
  "requiresVerification": true
}
```
**Edge Cases:**
- Email already registered → 409 Conflict
- Weak password → 400 Bad Request
- Invalid email → 400 Bad Request

**Integration:** Use Supabase Auth API for user creation and email verification.
**Security:** Rate limit registration attempts.

### POST `/api/auth/login`
**Purpose:** Authenticate user and issue JWT (Supabase)

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "StrongPassword123!"
}
```
**Validation:** Email and password required.

**Response:**
```json
{
  "user": { "id": "uuid", "email": "user@example.com", "name": "John Doe", "role": "caregiver" },
  "token": "jwt-token"
}
```
**Edge Cases:**
- Invalid credentials → 401 Unauthorized
- Unverified email → 403 Forbidden, with message

**Integration:** Use Supabase Auth sign-in.
**Security:** Rate limit login attempts, log suspicious activity.

### POST `/api/auth/logout`
**Purpose:** Invalidate user session (Supabase)

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Expired/invalid token → 401 Unauthorized

### POST `/api/auth/refresh`
**Purpose:** Refresh JWT using refresh token (Supabase)

**Request Body:** `{ "refreshToken": "..." }`
**Response:** `{ "token": "new-jwt-token" }`
**Edge Cases:** Invalid/expired refresh token → 401 Unauthorized

### GET `/api/auth/profile`
**Purpose:** Get current user profile

**Headers:** `Authorization: Bearer <token>`
**Response:**
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "John Doe",
  "avatar_url": "https://...",
  "role": "caregiver",
  "created_at": "2024-06-13T12:00:00Z"
}
```
**Edge Cases:** Expired/invalid token → 401 Unauthorized

### PUT `/api/auth/profile`
**Purpose:** Update user profile

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ "name": "Jane Doe", "avatar_url": "https://..." }`
**Validation:** Name min 2 chars, avatar_url valid URL (optional)
**Response:** `{ "user": { ...updated fields... } }`
**Edge Cases:** Invalid input → 400 Bad Request

### POST `/api/auth/verify-email`
**Purpose:** Verify email with token (Supabase)

**Request Body:** `{ "token": "..." }`
**Response:** `{ "success": true }`
**Edge Cases:** Invalid/expired token → 400 Bad Request

### POST `/api/auth/resend-verification`
**Purpose:** Resend verification email (Supabase)

**Request Body:** `{ "email": "user@example.com" }`
**Response:** `{ "success": true }`
**Edge Cases:** Email not found → 404 Not Found

### POST `/api/auth/reset-password`
**Purpose:** Send password reset email (Supabase)

**Request Body:** `{ "email": "user@example.com" }`
**Response:** `{ "success": true }`
**Edge Cases:** Email not found → 404 Not Found

### POST `/api/auth/update-password`
**Purpose:** Update password (Supabase)

**Headers:** `Authorization: Bearer <token>` or token in body
**Request Body:** `{ "password": "NewStrongPassword123!" }`
**Validation:** Password min 8 chars, strong
**Response:** `{ "success": true }`
**Edge Cases:** Invalid/expired token → 401 Unauthorized

---

## 2. Patient Management

## GET `/api/patients`
**Purpose:** List all patients accessible to the current user (caregiver)

**Headers:** `Authorization: Bearer <token>`
**Query:** `?search=...&conditions=...&age=...&page=1&pageSize=20`
**Validation:**
- `search`: optional, string
- `conditions`: optional, comma-separated string
- `age`: optional, number or range
- `page`, `pageSize`: optional, positive integers

**Response:**
```json
{
  "patients": [
    { "id": "uuid", "name": "Jane Smith", "dob": "2010-01-01", "gender": "female", ... },
    ...
  ],
  "total": 42,
  "page": 1,
  "pageSize": 20
}
```
**Edge Cases:**
- No patients found → empty array
- Invalid query params → 400 Bad Request

**Integration:** Query Postgres with RLS for user access. Use indexes for search.
**Security:** Only return patients the user is authorized to view.

---

## POST `/api/patients`
**Purpose:** Create a new patient profile

**Headers:** `Authorization: Bearer <token>`
**Request Body:**
```json
{
  "name": "Jane Smith",
  "dob": "2010-01-01",
  "gender": "female",
  "allergies": ["penicillin"],
  "medical_conditions": ["asthma"],
  "emergency_contact": { "name": "John Smith", "phone": "+1234567890", "relationship": "parent" }
}
```
**Validation:**
- `name`: required, min 2 chars
- `dob`: required, valid date, not in future
- `gender`: required, enum [male, female, other]
- `allergies`, `medical_conditions`: optional, array of strings
- `emergency_contact`: required, object with name, phone, relationship

**Response:**
```json
{
  "patient": { "id": "uuid", ... }
}
```
**Edge Cases:**
- Duplicate patient (same name/dob) → 409 Conflict
- Invalid input → 400 Bad Request

**Integration:** Insert into Postgres, create patient_caregivers link for creator.
**Security:** Only authenticated users can create patients.

---

## GET `/api/patients/:id`
**Purpose:** Get a single patient profile and caregivers

**Headers:** `Authorization: Bearer <token>`
**Response:**
```json
{
  "patient": { "id": "uuid", ... },
  "caregivers": [ { "id": "uuid", "name": "...", "role": "primary" }, ... ]
}
```
**Edge Cases:**
- Not found or not authorized → 404 Not Found

**Integration:** Join patients and patient_caregivers tables.
**Security:** RLS: only caregivers assigned to patient can view.

---

## PUT `/api/patients/:id`
**Purpose:** Update patient profile

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ ...fields }`
**Validation:** Only allow updatable fields, validate types
**Response:** `{ "patient": { ...updated fields... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update Postgres, audit changes.
**Security:** Only authorized caregivers can update.

---

## DELETE `/api/patients/:id`
**Purpose:** Delete patient profile

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Soft delete or cascade delete in Postgres.
**Security:** Only primary caregiver or admin can delete.

---

## GET `/api/patients/:id/caregivers`
**Purpose:** List caregivers for a patient

**Headers:** `Authorization: Bearer <token>`
**Response:**
```json
[
  { "id": "uuid", "name": "...", "email": "...", "role": "primary" },
  ...
]
```
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Query patient_caregivers table.
**Security:** Only assigned caregivers can view.

---

## POST `/api/patients/:id/caregivers`
**Purpose:** Add a caregiver to a patient

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ "caregiver_id": "uuid", "role": "secondary" }`
**Validation:** caregiver_id must exist, role must be valid
**Response:** `{ "success": true }`
**Edge Cases:** Already assigned → 409 Conflict

**Integration:** Insert into patient_caregivers.
**Security:** Only primary caregiver or admin can add.

---

## DELETE `/api/patients/:patientId/caregivers/:caregiverId`
**Purpose:** Remove a caregiver from a patient

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Delete from patient_caregivers.
**Security:** Only primary caregiver or admin can remove.

---

## GET `/api/patients/search`
**Purpose:** Search patients by name, condition, or age

**Headers:** `Authorization: Bearer <token>`
**Query:** `?query=...&conditions=...&age=...`
**Response:**
```json
[
  { "id": "uuid", "name": "...", ... },
  ...
]
```
**Edge Cases:** No results → empty array

**Integration:** Use Postgres full-text search.
**Security:** Only return authorized patients.

---

## 3. Medication Management

## GET `/api/patients/:patientId/medications`
**Purpose:** List all medications for a patient

**Headers:** `Authorization: Bearer <token>`
**Response:**
```json
[
  { "id": "uuid", "name": "Aspirin", "dosage": "100mg", "form": "tablet", "frequency": "once_daily", ... },
  ...
]
```
**Edge Cases:** No medications → empty array

**Integration:** Query medications table, filter by patient_id.
**Security:** Only caregivers for patient can view.

---

## POST `/api/patients/:patientId/medications`
**Purpose:** Add a new medication for a patient

**Headers:** `Authorization: Bearer <token>`
**Request Body:**
```json
{
  "name": "Aspirin",
  "dosage": "100mg",
  "form": "tablet",
  "frequency": "once_daily",
  "instructions": "Take with food",
  "prescribed_by": "Dr. Smith",
  "start_date": "2024-06-01",
  "end_date": "2024-06-30"
}
```
**Validation:**
- `name`, `dosage`, `form`, `frequency`: required
- `start_date`, `end_date`: valid dates

**Response:**
```json
{
  "medication": { "id": "uuid", ... }
}
```
**Edge Cases:** Duplicate medication (same name/dates) → 409 Conflict

**Integration:** Insert into medications table.
**Security:** Only authorized caregivers can add.

---

## GET `/api/medications/:id`
**Purpose:** Get a single medication

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "medication": { ... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Query medications by id.
**Security:** Only authorized caregivers can view.

---

## PUT `/api/medications/:id`
**Purpose:** Update a medication

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ ...fields }`
**Validation:** Only allow updatable fields, validate types
**Response:** `{ "medication": { ...updated fields... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update medications table.
**Security:** Only authorized caregivers can update.

---

## DELETE `/api/medications/:id`
**Purpose:** Delete (soft) a medication

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Set is_active=false in medications table.
**Security:** Only authorized caregivers can delete.

---

## GET `/api/medications/:id/schedule`
**Purpose:** Get medication schedule

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "schedule": { ... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Query schedule field in medications table.
**Security:** Only authorized caregivers can view.

---

## PUT `/api/medications/:id/schedule`
**Purpose:** Update medication schedule

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ "schedule": { ... } }`
**Validation:** Schedule must be valid JSON
**Response:** `{ "medication": { ...updated fields... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update schedule field in medications table.
**Security:** Only authorized caregivers can update.

---

## GET `/api/medications/:id/history`
**Purpose:** Get medication history

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "history": [ ... ] }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Query history field in medications table.
**Security:** Only authorized caregivers can view.

---

## GET `/api/medications/:id/adherence`
**Purpose:** Get medication adherence data

**Headers:** `Authorization: Bearer <token>`
**Query:** `?period=30`
**Response:** `{ "adherence": { ... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Query adherence field or calculate from doses.
**Security:** Only authorized caregivers can view.

---

## 4. Dose Management

## GET `/api/patients/:patientId/doses`
**Purpose:** List all doses for a patient

**Headers:** `Authorization: Bearer <token>`
**Response:**
```json
[
  { "id": "uuid", "medication_id": "uuid", "scheduled_time": "2024-06-13T08:00:00Z", "status": "pending", ... },
  ...
]
```
**Edge Cases:** No doses → empty array

**Integration:** Query doses table, filter by patient_id.
**Security:** Only caregivers for patient can view.

---

## POST `/api/doses/:id/mark`
**Purpose:** Mark a dose as taken, missed, or skipped

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ "status": "taken", "notes": "Patient took dose late" }`
**Validation:**
- `status`: required, enum [taken, missed, skipped]
- `notes`: optional, string

**Response:** `{ "dose": { ...updated fields... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update status in doses table, log who marked.
**Security:** Only authorized caregivers can mark.

---

## GET `/api/doses/today`
**Purpose:** List all doses scheduled for today for the current user

**Headers:** `Authorization: Bearer <token>`
**Response:** `[ ... ]`
**Edge Cases:** No doses → empty array

**Integration:** Query doses for today, filter by user.
**Security:** Only authorized caregivers can view.

---

## 5. Measurement Management

## GET `/api/patients/:patientId/measurements`
**Purpose:** List all measurements for a patient

**Headers:** `Authorization: Bearer <token>`
**Query:** `?type=...&period=...&startDate=...&endDate=...&limit=100`
**Validation:**
- `type`: optional, string
- `period`: optional, number of days
- `startDate`, `endDate`: optional, ISO date
- `limit`: optional, max 1000

**Response:**
```json
[
  { "id": "uuid", "type": "blood_pressure", "value": 120, "recordedAt": "2024-06-13T08:00:00Z", ... },
  ...
]
```
**Edge Cases:** No measurements → empty array

**Integration:** Query measurements table, filter by patient_id and type/date.
**Security:** Only caregivers for patient can view.

---

## POST `/api/patients/:patientId/measurements`
**Purpose:** Add a new measurement for a patient

**Headers:** `Authorization: Bearer <token>`
**Request Body:**
```json
{
  "type": "blood_pressure",
  "value": 120,
  "recordedAt": "2024-06-13T08:00:00Z",
  "notes": "Morning reading",
  "attachments": ["fileId1", "fileId2"]
}
```
**Validation:**
- `type`: required, valid measurement type
- `value`: required, number or string (depending on type)
- `recordedAt`: required, ISO date
- `notes`: optional, string
- `attachments`: optional, array of file IDs

**Response:**
```json
{
  "measurement": { "id": "uuid", ... }
}
```
**Edge Cases:** Invalid type/value → 400 Bad Request

**Integration:** Insert into measurements table, link attachments.
**Security:** Only authorized caregivers can add.

---

## PUT `/api/measurements/:id`
**Purpose:** Update a measurement

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ ...fields }`
**Validation:** Only allow updatable fields, validate types
**Response:** `{ "measurement": { ...updated fields... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update measurements table.
**Security:** Only authorized caregivers can update.

---

## DELETE `/api/measurements/:id`
**Purpose:** Delete a measurement

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Delete from measurements table.
**Security:** Only authorized caregivers can delete.

---

## GET `/api/measurements/presets`
**Purpose:** List available measurement presets

**Headers:** `Authorization: Bearer <token>`
**Response:**
```json
[
  { "name": "comprehensive", "settings": { ... } },
  ...
]
```
**Edge Cases:** No presets → empty array

**Integration:** Query measurement_presets table.
**Security:** Only authenticated users can view.

---

## POST `/api/measurements/preferences`
**Purpose:** Set measurement preferences for a patient

**Headers:** `Authorization: Bearer <token>`
**Request Body:**
```json
{
  "patientId": "uuid",
  "preferences": { ... }
}
```
**Validation:** Preferences object must match schema
**Response:** `{ "preferences": { ... } }`
**Edge Cases:** Invalid input → 400 Bad Request

**Integration:** Upsert into measurement_preferences table.
**Security:** Only authorized caregivers can set.

---

## GET `/api/measurements/preferences?patientId=...`
**Purpose:** Get measurement preferences for a patient

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "preferences": { ... } }`
**Edge Cases:** Not found → return default

**Integration:** Query measurement_preferences table.
**Security:** Only authorized caregivers can view.

---

## 6. Daily Logs

## GET `/api/patients/:patientId/logs`
**Purpose:** List all daily logs for a patient

**Headers:** `Authorization: Bearer <token>`
**Query:** `?type=...&severity=...&startDate=...&endDate=...&limit=100`
**Validation:**
- `type`, `severity`: optional, string
- `startDate`, `endDate`: optional, ISO date
- `limit`: optional, max 1000

**Response:**
```json
[
  { "id": "uuid", "type": "incident", "value": "Fell in bathroom", "recordedAt": "2024-06-13T08:00:00Z", ... },
  ...
]
```
**Edge Cases:** No logs → empty array

**Integration:** Query daily_logs table, filter by patient_id and type/date.
**Security:** Only caregivers for patient can view.

---

## POST `/api/patients/:patientId/logs`
**Purpose:** Add a new daily log for a patient

**Headers:** `Authorization: Bearer <token>`
**Request Body:**
```json
{
  "type": "incident",
  "value": "Fell in bathroom",
  "recordedAt": "2024-06-13T08:00:00Z",
  "notes": "No injury",
  "attachments": ["fileId1"]
}
```
**Validation:**
- `type`, `value`, `recordedAt`: required
- `notes`: optional, string
- `attachments`: optional, array of file IDs

**Response:**
```json
{
  "log": { "id": "uuid", ... }
}
```
**Edge Cases:** Invalid input → 400 Bad Request

**Integration:** Insert into daily_logs table, link attachments.
**Security:** Only authorized caregivers can add.

---

## PUT `/api/logs/:id`
**Purpose:** Update a daily log

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ ...fields }`
**Validation:** Only allow updatable fields, validate types
**Response:** `{ "log": { ...updated fields... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update daily_logs table.
**Security:** Only authorized caregivers can update.

---

## DELETE `/api/logs/:id`
**Purpose:** Delete a daily log

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Delete from daily_logs table.
**Security:** Only authorized caregivers can delete.

---

## GET `/api/patients/:patientId/logs/stats`
**Purpose:** Get statistics for daily logs

**Headers:** `Authorization: Bearer <token>`
**Query:** `?period=30`
**Response:** `{ "stats": { ... } }`
**Edge Cases:** No data → empty stats

**Integration:** Aggregate daily_logs table.
**Security:** Only caregivers for patient can view.

---

## GET `/api/patients/:patientId/logs/trends`
**Purpose:** Get trends for daily logs

**Headers:** `Authorization: Bearer <token>`
**Query:** `?type=...&period=30`
**Response:** `{ "trends": { ... } }`
**Edge Cases:** No data → empty trends

**Integration:** Aggregate daily_logs table.
**Security:** Only caregivers for patient can view.

---

## GET `/api/logs/templates`
**Purpose:** List available log templates

**Headers:** `Authorization: Bearer <token>`
**Query:** `?type=...`
**Response:** `[ ... ]`
**Edge Cases:** No templates → empty array

**Integration:** Query log_templates table.
**Security:** Only authenticated users can view.

---

## 7. Appointments

## GET `/api/appointments`
**Purpose:** List all appointments for the current user

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...&type=...&status=...&startDate=...&endDate=...&limit=100`
**Validation:**
- `patientId`, `type`, `status`: optional, string
- `startDate`, `endDate`: optional, ISO date
- `limit`: optional, max 1000

**Response:**
```json
[
  { "id": "uuid", "title": "Checkup", "dateTime": "2024-06-13T10:00:00Z", "duration": 30, ... },
  ...
]
```
**Edge Cases:** No appointments → empty array

**Integration:** Query appointments table, filter by user and patient.
**Security:** Only authorized users can view.

---

## POST `/api/appointments`
**Purpose:** Create a new appointment

**Headers:** `Authorization: Bearer <token>`
**Request Body:**
```json
{
  "title": "Checkup",
  "doctor": "Dr. Smith",
  "dateTime": "2024-06-13T10:00:00Z",
  "duration": 30,
  "location": "Clinic",
  "address": "123 Main St",
  "type": "medical",
  "notes": "Bring previous reports",
  "reminders": ["24_hours", "1_hour"],
  "patientId": "uuid"
}
```
**Validation:**
- `title`, `dateTime`, `duration`, `patientId`: required
- `duration`: positive integer

**Response:**
```json
{
  "appointment": { "id": "uuid", ... }
}
```
**Edge Cases:** Overlapping/conflicting appointment → 409 Conflict

**Integration:** Insert into appointments table.
**Security:** Only authorized users can create.

---

## GET `/api/appointments/:id`
**Purpose:** Get a single appointment

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "appointment": { ... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Query appointments by id.
**Security:** Only authorized users can view.

---

## PUT `/api/appointments/:id`
**Purpose:** Update an appointment

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ ...fields }`
**Validation:** Only allow updatable fields, validate types
**Response:** `{ "appointment": { ...updated fields... } }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update appointments table.
**Security:** Only authorized users can update.

---

## DELETE `/api/appointments/:id`
**Purpose:** Delete an appointment

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Delete from appointments table.
**Security:** Only authorized users can delete.

---

## GET `/api/appointments/upcoming`
**Purpose:** List upcoming appointments

**Headers:** `Authorization: Bearer <token>`
**Query:** `?days=7&patientId=...`
**Response:** `[ ... ]`
**Edge Cases:** No appointments → empty array

**Integration:** Query appointments table for next N days.
**Security:** Only authorized users can view.

---

## GET `/api/appointments/stats`
**Purpose:** Get appointment statistics

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...&period=30`
**Response:** `{ "stats": { ... } }`
**Edge Cases:** No data → empty stats

**Integration:** Aggregate appointments table.
**Security:** Only authorized users can view.

---

## 8. Caregiver Management

## GET `/api/caregivers`
**Purpose:** List all caregivers for the current user

**Headers:** `Authorization: Bearer <token>`
**Response:**
```json
[
  { "id": "uuid", "name": "...", "email": "...", "role": "primary", ... },
  ...
]
```
**Edge Cases:** No caregivers → empty array

**Integration:** Query patient_caregivers table, filter by caregiver_id.
**Security:** Only authenticated users can view.

---

## POST `/api/caregivers/invite`
**Purpose:** Invite a new caregiver to a patient

**Headers:** `Authorization: Bearer <token>`
**Request Body:**
```json
{
  "email": "caregiver@example.com",
  "patientId": "uuid",
  "role": "secondary"
}
```
**Validation:**
- `email`: required, valid email
- `patientId`: required, uuid
- `role`: required, valid role

**Response:**
```json
{
  "invitation": { "id": "uuid", ... }
}
```
**Edge Cases:** Already invited/assigned → 409 Conflict

**Integration:** Insert into caregiver_invitations, send email (Firebase/SMTP).
**Security:** Only authorized users can invite.

---

## DELETE `/api/caregivers/:id`
**Purpose:** Remove a caregiver from all patients

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Delete from patient_caregivers and invitations.
**Security:** Only authorized users can remove.

---

## POST `/api/caregivers/accept/:token`
**Purpose:** Accept a caregiver invitation

**Request Body:** `{ "token": "..." }`
**Response:** `{ "success": true }`
**Edge Cases:** Invalid/expired token → 400 Bad Request

**Integration:** Update patient_caregivers, mark invitation accepted.
**Security:** Token must be single-use and time-limited.

---

## 9. Notifications (Firebase)

## GET `/api/notifications`
**Purpose:** List notifications for the current user

**Headers:** `Authorization: Bearer <token>`
**Query:** `?limit=50`
**Response:**
```json
[
  { "id": "uuid", "type": "medication_reminder", "title": "Take Aspirin", "message": "It's time for your dose.", "read": false, "timestamp": "2024-06-13T08:00:00Z", ... },
  ...
]
```
**Edge Cases:** No notifications → empty array

**Integration:** Query notifications table (Postgres) and Firebase for push.
**Security:** Only authenticated users can view.

---

## POST `/api/notifications/:id/read`
**Purpose:** Mark a notification as read

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "success": true }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Update notifications table.
**Security:** Only owner can mark as read.

---

## GET `/api/notifications/preferences`
**Purpose:** Get notification preferences

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "preferences": { ... } }`
**Edge Cases:** Not found → return default

**Integration:** Query notification_preferences table.
**Security:** Only owner can view.

---

## POST `/api/notifications/preferences`
**Purpose:** Set notification preferences

**Headers:** `Authorization: Bearer <token>`
**Request Body:** `{ "preferences": { ... } }`
**Validation:** Preferences object must match schema
**Response:** `{ "preferences": { ... } }`
**Edge Cases:** Invalid input → 400 Bad Request

**Integration:** Upsert into notification_preferences table.
**Security:** Only owner can set.

---

## 10. File Uploads (Wasabi)

## POST `/api/files/upload`
**Purpose:** Upload a file (image, document, etc.)

**Headers:** `Authorization: Bearer <token>`
**FormData:** `file`, `patientId`, `type`, ...
**Validation:**
- `file`: required, max size 10MB, allowed types (jpg, png, pdf, ...)
- `patientId`: required, uuid
- `type`: required, enum [measurement, log, ...]

**Response:**
```json
{
  "fileId": "uuid",
  "url": "https://wasabi-bucket/..."
}
```
**Edge Cases:** Invalid file/type → 400 Bad Request

**Integration:** Upload to Wasabi, store metadata in Postgres, return signed URL.
**Security:** Only authorized users can upload. Virus scan files.

---

## GET `/api/files/:id/url`
**Purpose:** Get a signed URL for a file

**Headers:** `Authorization: Bearer <token>`
**Query:** `?expires=3600`
**Response:** `{ "url": "https://wasabi-bucket/..." }`
**Edge Cases:** Not found or not authorized → 404 Not Found

**Integration:** Generate signed URL from Wasabi.
**Security:** Only authorized users can access.

---

## GET `/api/files/:id/access-logs`
**Purpose:** Get file access logs

**Headers:** `Authorization: Bearer <token>`
**Query:** `?limit=50`
**Response:** `[ ... ]`
**Edge Cases:** No logs → empty array

**Integration:** Query file access logs table.
**Security:** Only authorized users can view.

---

## 11. Dashboard & Analytics

## GET `/api/dashboard/medication-overview`
**Purpose:** Get medication overview for dashboard

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...`
**Response:** `{ ... }`
**Edge Cases:** No data → empty object

**Integration:** Aggregate medications/doses for dashboard.
**Security:** Only authorized users can view.

---

## GET `/api/dashboard/alerts`
**Purpose:** Get dashboard alerts

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...`
**Response:** `{ ... }`
**Edge Cases:** No alerts → empty object

**Integration:** Aggregate alerts from various tables.
**Security:** Only authorized users can view.

---

## GET `/api/dashboard/quick-stats`
**Purpose:** Get quick stats for dashboard

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...`
**Response:** `{ ... }`
**Edge Cases:** No data → empty object

**Integration:** Aggregate stats from various tables.
**Security:** Only authorized users can view.

---

## GET `/api/dashboard/adherence-trends`
**Purpose:** Get adherence trends for dashboard

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...&period=30`
**Response:** `{ ... }`
**Edge Cases:** No data → empty object

**Integration:** Aggregate adherence from doses/medications.
**Security:** Only authorized users can view.

---

## GET `/api/dashboard/upcoming-events`
**Purpose:** Get upcoming events for dashboard

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...&days=7`
**Response:** `{ ... }`
**Edge Cases:** No events → empty object

**Integration:** Aggregate from appointments/doses.
**Security:** Only authorized users can view.

---

## GET `/api/dashboard/health-metrics`
**Purpose:** Get health metrics summary for dashboard

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...&period=30`
**Response:** `{ ... }`
**Edge Cases:** No data → empty object

**Integration:** Aggregate from measurements.
**Security:** Only authorized users can view.

---

## GET `/api/dashboard/care-team-activity`
**Purpose:** Get care team activity for dashboard

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...&limit=5`
**Response:** `{ ... }`
**Edge Cases:** No activity → empty object

**Integration:** Aggregate from patient_caregivers/logs.
**Security:** Only authorized users can view.

---

## GET `/api/dashboard/critical-alerts`
**Purpose:** Get critical alerts for dashboard

**Headers:** `Authorization: Bearer <token>`
**Query:** `?patientId=...`
**Response:** `{ ... }`
**Edge Cases:** No alerts → empty object

**Integration:** Aggregate from alerts/notifications.
**Security:** Only authorized users can view.

---

## 12. Sync & Export

## GET `/api/sync/all`
**Purpose:** Get all user data for sync

**Headers:** `Authorization: Bearer <token>`
**Query:** `?lastSync=...`
**Response:**
```json
{
  "patients": [ ... ],
  "medications": [ ... ],
  "doses": [ ... ],
  "measurements": [ ... ],
  "daily_logs": [ ... ],
  "notifications": [ ... ]
}
```
**Edge Cases:** No data → empty arrays

**Integration:** Query all relevant tables, filter by user and lastSync.
**Security:** Only authorized users can sync.

---

## GET `/api/export/appointments`
**Purpose:** Export appointments (e.g., iCal)

**Headers:** `Authorization: Bearer <token>`
**Query:** `?format=ical&...`
**Response:** File download or URL
**Edge Cases:** No appointments → empty file

**Integration:** Generate export from appointments table.
**Security:** Only authorized users can export.

---

## 13. Miscellaneous

## GET `/api/logs/templates`
**Purpose:** List available log templates

**Headers:** `Authorization: Bearer <token>`
**Query:** `?type=...`
**Response:** `[ ... ]`
**Edge Cases:** No templates → empty array

**Integration:** Query log_templates table.
**Security:** Only authenticated users can view.

---

## GET `/api/measurements/availability?patientId=...`
**Purpose:** Get measurement availability for a patient

**Headers:** `Authorization: Bearer <token>`
**Response:** `{ "categories": { ... }, "measurements": { ... } }`
**Edge Cases:** Not found → return default

**Integration:** Query measurement_preferences and presets.
**Security:** Only authorized caregivers can view.

---

# General Security/Production Notes
- All endpoints must validate authentication and authorization.
- Use Supabase for user/session management and RLS for data security.
- File uploads must be securely proxied to Wasabi and URLs signed.
- Notification endpoints must integrate with Firebase for push/email.
- All endpoints must return clear error messages and handle edge cases (e.g., missing data, permissions, invalid input).
- All list endpoints should support pagination and filtering where appropriate.
- All date/time fields must be ISO 8601.
- All IDs are UUIDs.
- All endpoints must be CORS-enabled for the frontend domain.
- All endpoints must be rate-limited and protected against abuse.
- All input must be validated and sanitized to prevent injection attacks.
- All sensitive actions must be logged for audit.

---

This document is exhaustive and should be used as the contract for backend implementation. If any new UI features are added, this document should be updated accordingly. 